---
title: "Hosting Node.js on Microsoft Azure"
featured_image: 
description:
date: 2015-03-18
tags: posts
slug: hosting-node-js-on-microsoft-azure
layout: layouts/post.njk
---

<!--kg-card-begin: markdown--><p>Got a fresh Node.js application to deploy? Awesome! Microsoft Azure has several options for hosting Node.js applications. In this article, we will be looking specifically at deploying to Windows Server websites and virtual machines.</p>
<h2 id="azurewebsite">Azure website</h2>
<p>An Azure website is an easy and straightforward way to deploy a Node.js application. From the Azure portal:</p>
<ol>
<li>Click &quot;<strong>+ New</strong>&quot;</li>
<li>Choose <strong>Compute</strong> &gt; <strong>Website</strong> &gt; <strong>From Gallery</strong></li>
<li>Choose <strong>Templates</strong> &gt; <strong>Node JS Empty Site</strong></li>
<li>Enter a name for the site</li>
</ol>
<p>Congratulations, you now have an Azure website configured for Node.js, ready for you to start uploading your files. Azure conveniently provides a URL to test your application, such as <em>myappname.azurewebsites.net</em>.</p>
<p>This option automatically creates <code>web.config</code> and <code>server.js</code> files. You can use FTP to download these files, make changes, and upload your application. Or, better yet, <a href="http://azure.microsoft.com/en-us/documentation/articles/web-sites-publish-source-control/">set up automatic deployment</a> with GitHub, Bitbucket, Dropbox, or a number of other solutions.</p>
<blockquote>
<p>Note: If the entry point for your Node.js application is not <code>server.js</code>, such as <code>src/index.js</code>, be sure to update the <code>web.config</code> to point to the correct main file.</p>
</blockquote>
<h2 id="azurevirtualmachineusingiisnode">Azure virtual machine using iisnode</h2>
<p>An Azure Windows Server virtual machine (VM) is a good option if you are more comfortable with managing Windows Server, need to host more than one web application on the same VM (e.g. a mix of Node.js and ASP.NET applications), or have deployment requirements not supported by Azure websites. There are also a number of <a href="https://github.com/tjanczuk/iisnode/wiki">benefits to using iisnode</a> when hosting a Node.js application on Windows Server.</p>
<h3 id="whatyouwillneed">What you will need...</h3>
<ul>
<li>IIS</li>
<li><a href="https://nodejs.org/">Node.js</a> (x64)</li>
<li><a href="http://www.microsoft.com/en-us/download/details.aspx?id=14632">Microsoft Visual C++ 2010 Redistributable Package (x64)</a></li>
<li><a href="https://www.python.org/downloads/">python 2.x</a></li>
<li><a href="https://github.com/tjanczuk/iisnode/releases">iisnode</a> (x64)</li>
<li>URL Rewrite module for IIS - use the <a href="http://www.microsoft.com/web/downloads/platform.aspx">Microsoft Platform Installer</a> to install</li>
</ul>
<blockquote>
<p>Note: Use the Windows Server <strong>Add Roles and Features</strong> Wizard to install IIS. C++ and Python are required to build certain Node.js modules (dependencies).</p>
</blockquote>
<h4 id="anamechocolateyaprotipchocolatey"><a name="chocolatey"></a>Pro Tip: Chocolatey</h4>
<p>For managing applications on Windows machines, <a href="https://chocolatey.org/">Chocolatey</a> is <em>the</em> way to go. It can save you a lot of time setting up virtual machines, or the next time you decide to pave and reinstall your Windows development PC.</p>
<p>Unfortunately, not all the dependencies required for iisnode are available as Chocolately packages. However, you can save some time installing those that are.</p>
<ul>
<li>Install IIS</li>
<li><a href="https://chocolatey.org/">Install Chocolatey</a></li>
<li>Run the following:</li>
</ul>
<pre><code>C:\&gt; choco install python2
C:\&gt; choco install vcredist2010
C:\&gt; choco install nodejs.install
C:\&gt; choco install urlrewrite
</code></pre>
<ul>
<li>Install <a href="https://github.com/tjanczuk/iisnode/releases">iisnode</a> (x64)</li>
</ul>
<h3 id="stepstodeploythefirsttime">Steps to deploy the first time</h3>
<ol>
<li>Create a new Azure VM, or manage an existing VM</li>
<li>Install the requirements on the Azure VM</li>
<li>Add a <code>web.config</code> file to your Node.js application</li>
<li>Copy your Node.js application to the VM</li>
<li>Delete the <code>node_modules</code>, if it exists</li>
<li>Run <code>npm install</code> to install application dependencies</li>
<li>Add any system environment variables</li>
<li>Add a new web site to IIS</li>
</ol>
<h4 id="whydoineedtorunnpminstall">Why do I need to run npm install?</h4>
<p>Some Node modules include C code that must be compiled to match the current OS and architecture (x86 or x64). This makes it possible to develop a Node.js application on one OS (i.e. Mac OS X, Linux, or Windows) and deploy to another OS. Although it's possible to create builds for each target OS and architecture, many times the <code>node_modules</code> folder is not included in deployment. Rather, it is built on the target system using <code>npm install</code>.</p>
<h4 id="environmentvariables">Environment variables</h4>
<p>Some Node.js applications and frameworks require environment variables for proper configuration, such as production environment settings or database connection information. The key to remember here, these environment variables must be added as <em>system</em> variables.</p>
<p><img src="/content/images/2015/03/add-node-env.gif" alt="System variables"></p>
<h4 id="youregoingtoneedthatwebconfig">You're going to need that web.config</h4>
<p>You will need to add a <code>web.config</code> file to your Node.js application to configure iisnode. The following is a sample file. Read the in-line comments carefully.</p>
<pre><code>&lt;configuration&gt;
  &lt;system.webServer&gt;
    &lt;handlers&gt;
      &lt;!-- path to application main file --&gt;
      &lt;add name=&quot;iisnode&quot; path=&quot;server.js&quot; verb=&quot;*&quot; modules=&quot;iisnode&quot; /&gt;
    &lt;/handlers&gt;
    &lt;rewrite&gt;
      &lt;rules&gt;
        &lt;!-- Don't interfere with requests for node-inspector debugging --&gt;
        &lt;rule name=&quot;NodeInspector&quot; patternSyntax=&quot;ECMAScript&quot; stopProcessing=&quot;true&quot;&gt;
          &lt;match url=&quot;^server.js\/debug[\/]?&quot; /&gt;
        &lt;/rule&gt;
        
        &lt;!-- If you have static content, such as HTML, script files, CSS, or images, put them all in one place, such as a folder named public --&gt;
        &lt;rule name=&quot;StaticContent&quot;&gt;
          &lt;action type=&quot;Rewrite&quot; url=&quot;public{REQUEST_URI}&quot; /&gt;
        &lt;/rule&gt;
        
        &lt;!-- All other URLs are mapped to the Node.js application --&gt;
        &lt;rule name=&quot;DynamicContent&quot;&gt;
          &lt;conditions&gt;
            &lt;add input=&quot;{REQUEST_FILENAME}&quot; matchType=&quot;IsFile&quot; negate=&quot;True&quot; /&gt;
          &lt;/conditions&gt;
          &lt;action type=&quot;Rewrite&quot; url=&quot;server.js&quot; /&gt;
        &lt;/rule&gt;
      &lt;/rules&gt;
    &lt;/rewrite&gt;
    
    &lt;!-- You can control how Node is hosted within IIS using the following options --&gt;
    &lt;!--&lt;iisnode
      node_env=&quot;%node_env%&quot;
      nodeProcessCountPerApplication=&quot;1&quot;
      maxConcurrentRequestsPerProcess=&quot;1024&quot;
      maxNamedPipeConnectionRetry=&quot;3&quot;
      namedPipeConnectionRetryDelay=&quot;2000&quot;
      maxNamedPipeConnectionPoolSize=&quot;512&quot;
      maxNamedPipePooledConnectionAge=&quot;30000&quot;
      asyncCompletionThreadCount=&quot;0&quot;
      initialRequestBufferSize=&quot;4096&quot;
      maxRequestBufferSize=&quot;65536&quot;
      watchedFiles=&quot;*.js&quot;
      uncFileChangesPollingInterval=&quot;5000&quot;
      gracefulShutdownTimeout=&quot;60000&quot;
      loggingEnabled=&quot;true&quot;
      logDirectoryNameSuffix=&quot;logs&quot;
      debuggingEnabled=&quot;true&quot;
      debuggerPortRange=&quot;5058-6058&quot;
      debuggerPathSegment=&quot;debug&quot;
      maxLogFileSizeInKB=&quot;128&quot;
      appendToExistingLog=&quot;false&quot;
      logFileFlushInterval=&quot;5000&quot;
      devErrorsEnabled=&quot;true&quot;
      flushResponse=&quot;false&quot;
      enableXFF=&quot;false&quot;
      promoteServerVars=&quot;&quot;
      /&gt;--&gt;
    &lt;!-- Updates to any of these files will trigger app restart --&gt;
    &lt;iisnode watchedFiles=&quot;*.js;node_modules\*;routes\*.js;views\*.jade;views\account\*.jade;iisnode.yml&quot; /&gt;
  &lt;/system.webServer&gt;
&lt;/configuration&gt;
</code></pre>
<h4 id="addthewebsitetoiis">Add the website to IIS</h4>
<ol>
<li>Open up <strong>Internet Information Services (IIS) Manager</strong></li>
<li>Expand the local server</li>
<li>Right-click <strong>Sites</strong>, and click <strong>Add Website</strong></li>
<li>Fill out the form, and click <strong>OK</strong></li>
</ol>
<p><img src="/content/images/2015/03/add-website.gif" alt="Add Website"></p>
<blockquote>
<p>Note: It is your responsibility to manage DNS records to point your application's domain (web address) to the <strong>Public IP address</strong> of the Azure VM.</p>
</blockquote>
<p>Your Node.js application is now ready to roll!</p>
<h3 id="redeployingyourapptothevm">Redeploying your app to the VM</h3>
<ol>
<li>Copy your updated Node.js application to the VM</li>
<li>Delete the <code>node_modules</code>, if it exists</li>
<li>Run <code>npm install</code></li>
<li>Overwrite or merge your old version with the new version</li>
</ol>
<p>Similar to deploying an ASP.NET application, IIS will detect files have changed and restart the application.</p>
<h2 id="deployanodejsapplicationasaserviceonawindowsvm">Deploy a Node.js application as a service on a Windows VM</h2>
<p>This is a good option if you are more comfortable managing Windows Server, need to host one or more Node.js applications on the same VM, and do not need the complexity of installing IIS and iisnode. This is ideal for applications intended to run without a public-facing UI, such as Node.js application that acts upon messages published to a message queue.</p>
<h3 id="whatyouwillneed">What you will need...</h3>
<p>There are many options for running Node.js as a service, especially on Linux or Mac OS X. I have found <a href="http://jfromaniello.github.io/winser/">winser</a> to work well on Windows.</p>
<ul>
<li><a href="https://nodejs.org/">Node.js</a> (x64)</li>
<li><a href="http://www.microsoft.com/en-us/download/details.aspx?id=14632">Microsoft Visual C++ 2010 Redistributable Package (x64)</a></li>
<li><a href="https://www.python.org/downloads/">python 2.x</a></li>
<li><a href="http://jfromaniello.github.io/winser/">winser</a></li>
</ul>
<h3 id="stepstodeploythefirsttime">Steps to deploy the first time</h3>
<ol>
<li>Add <code>winser</code> as a dependency to your Node.js application</li>
<li>Install the requirements on the Azure VM (<a href="#chocolatey">see tip on Chocolatey</a>)</li>
<li>Add any system environment variables</li>
<li>Copy your Node.js application to the VM</li>
<li>Delete the <code>node_modules</code>, if it exists</li>
<li>Run <code>npm install</code></li>
<li>Run <code>npm run-script install-service</code></li>
</ol>
<h3 id="configuringwinser">Configuring winser</h3>
<p>Winser must be installed as a dependency in your Node.js application and configured in <code>package.json</code>.</p>
<pre><code>npm install --save winser
</code></pre>
<p>Next, edit <code>package.json</code> and add the following to your scripts, modifying to match your application's start file and name.</p>
<pre><code>  &quot;scripts&quot;: {
	&quot;start&quot;: &quot;node index.js&quot;,
    &quot;install-service&quot;: &quot;winser -i -s -a -n myapp-service-name&quot;,
    &quot;uninstall-service&quot;: &quot;winser -r -x -s -n myapp-service-name&quot;
  },

</code></pre>
<blockquote>
<p>Note: Make sure <code>start</code> accurately reflects how your application is run.</p>
</blockquote>
<h3 id="workthatservice">Work that Service</h3>
<p>With winser correctly configured, installing is a breeze. Open a command prompt and enter the following.</p>
<pre><code>C:\&gt; cd \[path to node.js application]
C:\my-awesome-app&gt; npm run-script install-service
</code></pre>
<p>If you look at <strong>Server Manager</strong> &gt; <strong>Tools</strong> &gt; <strong>Services</strong>, or use <code>net start</code>, you should see that your application is now running as a service. Like any other Windows service, you can stop and restart the application.</p>
<p><strong>Uninstall the service</strong></p>
<p>Uninstall is just as easy. Our <code>uninstall-service</code> script in <code>package.json</code> is configured to automatically stop and remove the service.</p>
<pre><code>C:\&gt; cd \[path to node.js application]
C:\my-awesome-app&gt; npm run-script uninstall-service
</code></pre>
<h3 id="redeployingyourservicetothevm">Redeploying your service to the VM</h3>
<ol>
<li>Copy your updated Node.js application to the VM</li>
<li>Delete the <code>node_modules</code>, if it exists</li>
<li>Run <code>npm install</code></li>
<li>Stop the service</li>
<li>Overwrite or merge your old version with the new version</li>
<li>Start the service</li>
</ol>
<!--kg-card-end: markdown-->
